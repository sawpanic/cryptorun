# CryptoRun Artifacts Management

## UX MUST — Live Progress & Explainability

The CryptoRun artifacts system provides **audit-ready file management** with atomic writes, configurable retention policies, and structured storage for all explainability outputs and operational logs.

## Overview

CryptoRun generates **point-in-time artifacts** that capture complete system state for regulatory compliance, debugging, and performance analysis. The system supports multiple artifact types with automatic retention management and atomic write operations.

## Artifact Types

### Explainability Artifacts
Complete decision transparency with factor attribution:
- **JSON**: Full-fidelity explainability reports with nested structures
- **CSV**: Console-optimized 18-column format for quick analysis
- **Generated by**: `internal/explain` package via scoring pipeline
- **Retention**: 30 days default, configurable per environment

### Ledger Artifacts (Legacy)
Point-in-time portfolio and execution logs:
- **JSON**: Portfolio snapshots, execution records
- **CSV**: Transaction logs, performance summaries  
- **Generated by**: `src/internal/artifacts` package via portfolio pipeline
- **Retention**: 90 days default (regulatory requirement)

### System Health Artifacts (Future)
Operational monitoring and performance tracking:
- **Metrics**: Provider latency, cache hit rates, error rates
- **Traces**: Request flows, dependency calls, circuit breaker events
- **Generated by**: Health monitoring system (planned)
- **Retention**: 14 days default

## Directory Structure

### Standard Layout
```
artifacts/
├── explain/                    # Explainability reports
│   ├── 20240115-103000-momentum_scan-explain.json
│   ├── 20240115-103000-momentum_scan-explain.csv  
│   ├── 20240115-154500-regime_change-explain.json
│   └── 20240115-154500-regime_change-explain.csv
├── ledger/                     # Legacy portfolio/execution logs
│   ├── 20240115-080000-portfolio.json
│   ├── 20240115-080000-execution.csv
│   └── archived/
│       └── 2024-01/
├── health/                     # System monitoring (future)
│   ├── 20240115-hourly-metrics.json
│   └── 20240115-traces.jsonl
└── config/                     # Configuration snapshots
    └── 20240115-active-config.json
```

### Environment-Specific Paths
```yaml
# Development
artifacts_base: "./artifacts"

# Staging  
artifacts_base: "/opt/cryptorun/artifacts"

# Production
artifacts_base: "/data/cryptorun/artifacts"
```

## File Naming Conventions

### Timestamp Format
```
Format: YYYYMMDD-HHMMSS-{prefix}-{type}.{ext}
Components:
  - YYYYMMDD: Date (UTC)
  - HHMMSS: Time (UTC) 
  - {prefix}: Operation identifier
  - {type}: Artifact type (explain, ledger, health)
  - {ext}: File extension (json, csv, jsonl)

Examples:
  20240115-103000-momentum_scan-explain.json
  20240115-080000-portfolio-ledger.json
  20240115-154500-regime_change-explain.csv
```

## Atomic Write Operations

### Write-Then-Rename Pattern
All artifact writes use atomic operations to prevent partial files:
```go
func (w *AtomicWriter) writeJSONAtomic(filename string, v interface{}) error {
    finalPath := filepath.Join(w.BaseDir, filename)
    tempPath := finalPath + ".tmp"
    
    // 1. Write to temporary file
    data, err := json.MarshalIndent(v, "", "  ")
    if err != nil {
        return err
    }
    
    if err := os.WriteFile(tempPath, data, 0644); err != nil {
        return err
    }
    
    // 2. Atomic rename (guaranteed by filesystem)
    if err := os.Rename(tempPath, finalPath); err != nil {
        os.Remove(tempPath)  // Cleanup on failure
        return err
    }
    
    return nil
}
```

## API Reference

### AtomicWriter
Primary interface for explainability artifacts:
```go
writer := artifacts.NewAtomicWriter("./artifacts/explain")
err := writer.WriteExplainReport(report, "momentum_scan")
```

### Legacy Writers (Maintained)
Original artifact functions for portfolio/execution logs:
```go
// JSON artifacts
err := artifacts.WriteJSON("portfolio", portfolioData)

// CSV artifacts  
rows := [][]string{{"symbol", "score"}, {"BTC-USD", "85.5"}}
err := artifacts.WriteCSV("results", rows)
```

## Integration Examples

### Explainability Pipeline
```go
import (
    "cryptorun/internal/explain"
    "cryptorun/src/internal/artifacts"
)

// Generate complete explainability report
collector := explain.NewDataCollector("v3.2.1", "./artifacts/explain")
report, err := collector.GenerateReport(ctx, symbols, inputs)
if err != nil {
    return err
}

// Write atomic artifacts (JSON + CSV)
writer := artifacts.NewAtomicWriter("./artifacts/explain")
return writer.WriteExplainReport(report, "momentum_scan")
```

### Legacy Portfolio Logging
```go
// Portfolio snapshots (maintained for compatibility)
portfolioState := map[string]interface{}{
    "timestamp": time.Now().UTC(),
    "positions": positions,
    "cash":      cash,
    "pnl":       pnl,
}

err := artifacts.WriteJSON("portfolio", portfolioState)
```

## Configuration

### Environment Variables
```bash
# Artifact base directory
export CRYPTORUN_ARTIFACTS_DIR="./artifacts"

# Retention policies
export CRYPTORUN_EXPLAIN_RETENTION_DAYS="30"
export CRYPTORUN_LEDGER_RETENTION_DAYS="90"
```

### Config File Support
```yaml
# config/artifacts.yaml
base_dir: "./artifacts"
retention:
  explain: 30
  ledger: 90
  health: 14
formats:
  json_indent: 2
  csv_precision: 6
```

## Performance & Limits

### File Sizes
- **Explainability JSON** (100 assets): ~500KB
- **Explainability CSV** (100 assets): ~25KB  
- **Portfolio JSON**: ~100KB
- **Execution CSV** (1000 trades): ~200KB

### Write Performance
- **Small files** (<1MB): 10-50ms
- **Large files** (1-10MB): 50-200ms
- **Concurrent writers**: Up to 10 goroutines safely

### Directory Limits
- **Files per directory**: <10,000 (filesystem performance)
- **Total directory size**: <10GB (backup performance)
- **Retention period**: Configurable per artifact type

This artifacts system ensures reliable, auditable, and performant storage of all CryptoRun operational data.

